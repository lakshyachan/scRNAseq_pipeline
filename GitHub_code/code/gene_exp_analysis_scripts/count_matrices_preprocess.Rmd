---
title: "Count Matrices Pre-Processing"
---

```{r}
#Adding local R library to path
.libPaths(c(.libPaths(), "/home/lchanem1/rlibs/4.0.2/gcc/9.3.0"))
```

```{r}
library(edgeR)
library(DGEobj.utils)
library(data.table)
library(dplyr)
```

```{r}
# EdgeR cannot directly generate TPM values, hence convertCounts converts from FPKM values generated using edgeR
counts <- read.csv("/home/lchanem1/data-abattle4/lakshmi/cuomo_2020/gene_exp_analysis/d10_avg_expression.csv", row.names="Gene")
geneLength <- counts$size
counts_matrix <- select(counts, -ensembl_gene_id, -start_position, -end_position, -upper_bound, -lower_bound, -size)
rownames(counts_matrix) <- NULL
rownames(counts_matrix) <- counts_matrix$hgnc_symbol
counts_matrix <- select(counts_matrix, -hgnc_symbol)
#counts_matrix <- as.matrix(counts_matrix)
```

## Out of 11,231 initial genes, 10,335 genes were common between the gene annotations file and raw counts matrix.

## 139 out of the total list of genes originally in the matrix could not be traced to ENSEMBL BioMart for gene lengths. Had to be excluded from the analysis in 'counts'.

```{r}
# RUN THIS for raw coverage based analysis
# Normalize raw coverage by gene length
norm_counts <- counts_matrix / geneLength
norm_counts$hgnc_symbol = rownames(norm_counts)
```

## FINAL thresholds:

## High coverage genes: genes with count >= 0.05

## Low coverage genes: genes with count > 0 and < 0.000055

## Mid coverage genes: >= 0.000055 and < 0.05

## Zero coverage genes: genes with count = 0

## Arbitrary to approximate distribution such as high is ~13.5%, low is ~20.8%, mid is ~67.6%, zero is 0.78% of total genes.

```{r}
## Now getting corresponding gene IDs for each sample and each coverage bin
high_cov <- list()
low_cov <- list()
mid_cov <- list()
zero_cov <- list()

for (col_name in colnames(norm_counts[-11])){
  hc_genes <- rownames(norm_counts[norm_counts[, col_name] >= 0.005, col_name ,drop=FALSE])
  high_cov[[col_name]] <- hc_genes
  
  lc_genes <- rownames(norm_counts[norm_counts[, col_name] > 0 & norm_counts[, col_name] < 0.000055, col_name, drop=FALSE])
  low_cov[[col_name]] <- lc_genes
  
  mc_genes <- rownames(norm_counts[norm_counts[, col_name] >= 0.000055 & norm_counts[, col_name] < 0.005, col_name, drop=FALSE])
  mid_cov[[col_name]] <- mc_genes
  
  zc_genes <- rownames(norm_counts[norm_counts[, col_name] == 0, col_name, drop=FALSE])
  zero_cov[[col_name]] <- zc_genes
  
  # Storing them:
  high_path <- paste0("/home/lchanem1/data-abattle4/lakshmi/cuomo_2020/gene_exp_analysis/prev_expression_exclusions/id_lists/", col_name, "_high.txt")
  low_path <- paste0("/home/lchanem1/data-abattle4/lakshmi/cuomo_2020/gene_exp_analysis/prev_expression_exclusions/id_lists/", col_name, "_low.txt")
  mid_path <- paste0("/home/lchanem1/data-abattle4/lakshmi/cuomo_2020/gene_exp_analysis/prev_expression_exclusions/id_lists/", col_name, "_mid.txt")
  write.table(hc_genes, file =  high_path, sep = "\t", col.names = FALSE, row.names = FALSE, quote = FALSE)
  write.table(lc_genes, file = low_path, sep = "\t", col.names = FALSE, row.names = FALSE, quote = FALSE)
  write.table(mc_genes, file = mid_path, sep = "\t", col.names = FALSE, row.names = FALSE, quote = FALSE)
  if (!is.null(zc_genes) && length(zc_genes) > 0) {
    zero_path <- paste0("/home/lchanem1/data-abattle4/lakshmi/cuomo_2020/gene_exp_analysis/prev_expression_exclusions/id_lists/", col_name, "_zeros.txt")
    write.table(zc_genes, file =  zero_path, sep = "\t", col.names = FALSE, row.names = FALSE, quote = FALSE)
  }
}
```

## Visualisation of final distributions in each category
```{r}
## High Coverage
for (col_name in colnames(norm_counts[-11])){
  test <- norm_counts[norm_counts[col_name] >= 0.005, ]
  hist(log10(test[, col_name]), breaks = 50); abline(v = log10(0.005), col = "blue")
}
```

```{r}
## Low Coverage
for (col_name in colnames(norm_counts[-11])){
  test <- norm_counts[norm_counts[, col_name] > 0 & norm_counts[, col_name] < 0.000055, ]
  hist(log10(test[, col_name]), breaks = 50); abline(v = log10(0.000055), col = "blue")
}
```

```{r}
## Visualise the number of genes falling into each category for all 10 samples
nhigh <- list()
nlow <- list()
nmid <- list()
sample_names <- colnames(norm_counts[-11])
for (col_name in colnames(norm_counts[-11])){
  nhigh <- append(nhigh, length(high_cov[[col_name]]))
  nlow <- append(nlow, length(low_cov[[col_name]]))
  nmid <- append(nmid, length(mid_cov[[col_name]]))
}
nhigh <- unlist(nhigh)
nlow <- unlist(nlow)
nmid <- unlist(nmid)
data <- data.frame(sample_names, nhigh, nlow, nmid)

melted_data <- melt(data, id.vars = "sample_names")
primary_colors <- c("maroon", "darkgreen", "coral")

plot <- ggplot(melted_data, aes(x = sample_names, y = value, fill = variable)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(x = "Sample", y = "Number of Genes", fill = "Coverage Category") +
  scale_fill_manual(values = primary_colors) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1),
        axis.text.y = element_text(size = 12),
        axis.title.y = element_text(size = 14),
        plot.margin = unit(c(0.2, 0.5, 0.2, 0.5), "cm"))
plot
```

--------------------------------------------------------------------------------------------------------------------------------------------
##### UNNECESSARY: Test chunks

## Coverage Based Analysis

```{r}
# Divide into quantiles
highly_expressed_lists <- list()
lowly_expressed_lists <- list()

# Iterate over columns
for (col_name in colnames(norm_counts)) {
  quantiles <- quantile(norm_counts[, col_name], probs = c(0.05, 0.95))

  # Identify highly expressed genes (top 5%)
  highly_expressed_genes <- rownames(norm_counts[norm_counts[, col_name] >= quantiles[2], , drop = FALSE])
  highly_expressed_lists[[col_name]] <- highly_expressed_genes

  # Identify lowly expressed genes (bottom 5%)
  lowly_expressed_genes <- rownames(norm_counts[norm_counts[, col_name] <= quantiles[1], , drop = FALSE])
  lowly_expressed_lists[[col_name]] <- lowly_expressed_genes
}
```

```{r}
## RUN THIS for raw coverage based analysis
## Only to store the gene IDs, do not keep running multiple times, only when gene IDs are finalized
# RUN THIS before running the remaining chunk: 
# norm_counts$hgnc_symbol = rownames(norm_counts)
for (col_name in colnames(norm_counts)){
  high <- norm_counts[rownames(norm_counts) %in% highly_expressed_lists[[col_name]], "hgnc_symbol", drop = FALSE]
  low <- norm_counts[rownames(norm_counts) %in% lowly_expressed_lists[[col_name]], "hgnc_symbol", drop = FALSE]
  high_path <- paste0("/home/lchanem1/data-abattle4/lakshmi/cuomo_2020/gene_exp_analysis/id_lists/", col_name, "_high.txt")
  low_path <- paste0("/home/lchanem1/data-abattle4/lakshmi/cuomo_2020/gene_exp_analysis/id_lists/", col_name, "_low.txt")
  write.table(high, file =  high_path, sep = "\t", col.names = FALSE, row.names = FALSE, quote = FALSE)
  write.table(low, file = low_path, sep = "\t", col.names = FALSE, row.names = FALSE, quote = FALSE) 
}
```

```{r}
high_genes_list <- list()
for (col_name in colnames(norm_counts)){
  high <- norm_counts[rownames(norm_counts) %in% highly_expressed_lists[[col_name]], "hgnc_symbol", drop = FALSE]
  high_genes_list <- append(high_genes_list, unlist(high))
}
high_genes_list <- unique(unlist(high_genes_list))

## Now subset the count matrix to only include these highly expressed genes
temp <- norm_counts[norm_counts$hgnc_symbol %in% high_genes_list, ]
rownames(temp) <- NULL
#temp <- select(temp, -ensembl_gene_id, -start_position, -end_position, -upper_bound, -lower_bound, -size)
```

```{r}
library(ggplot2)
top.expr.df <- data.frame(norm_counts) %>% tidyr::pivot_longer(cols=colnames(norm_counts)[-11])
value_range <- range(top.expr.df$value)
head(data.frame(norm_counts))
top.expr.df

ggplot(top.expr.df, aes(x=value)) + geom_histogram() + facet_wrap(~name) + scale_x_continuous(limits = c(1, 17))
```

## Getting the min threshold for top 5% across all genes and samples

```{r}
max(apply(temp[,-11], 2, min))
```

## Finding threshold for low coverage genes

```{r}
low_genes_list <- list()
for (col_name in colnames(norm_counts)){
  low <- norm_counts[rownames(norm_counts) %in% lowly_expressed_lists[[col_name]], "hgnc_symbol", drop = FALSE]
  low_genes_list <- append(low_genes_list, unlist(low))
}
low_genes_list <- unique(unlist(low_genes_list))

low_temp <- norm_counts[norm_counts$hgnc_symbol %in% low_genes_list, ]
rownames(low_temp) <- NULL

apply(low_temp[,-11], 2, min)
```

```{r}
# RUN THIS FOR z-score based analysis
# Calculate TPMs
tpm_counts <- convertCounts(counts_matrix, unit = "TPM", geneLength = geneLength, log = FALSE, normalize = "none")

# As per z-score formula:
log_transformed_tpm <- log2(tpm_counts + 1)
z_scaled <- t(scale(t(log_transformed_tpm), scale = TRUE, center = TRUE))

# Create lists to store results
highly_expressed_lists <- list()
lowly_expressed_lists <- list()

# Iterate over columns
for (col_name in colnames(z_scaled)) {
  # Identify highly expressed genes (Z-score > 2) for the current column
  highly_expressed_genes <- rownames(z_scaled[z_scaled[, col_name] > 2, , drop = FALSE])
  highly_expressed_lists[[col_name]] <- highly_expressed_genes

  # Identify lowly expressed genes (Z-score < -2) for the current column
  lowly_expressed_genes <- rownames(z_scaled[z_scaled[, col_name] < -2, , drop = FALSE])
  lowly_expressed_lists[[col_name]] <- lowly_expressed_genes
}
```

```{r}
## RUN THIS for z-score analysis
## Getting a list of common gene IDs that are highly and lowly expressed
# Note: Make sure 'counts' has the common symbols un-dropped before running this. Re-run reading counts.
for (col_name in colnames(z_scaled)){
  high <- counts[rownames(counts) %in% highly_expressed_lists[[col_name]], "hgnc_symbol", drop = FALSE]
  low <- counts[rownames(counts) %in% lowly_expressed_lists[[col_name]], "hgnc_symbol", drop = FALSE]
  high_path <- paste0("/home/lchanem1/data-abattle4/lakshmi/cuomo_2020/gene_exp_analysis/high_exp/", col_name, "_high.txt")
  low_path <- paste0("/home/lchanem1/data-abattle4/lakshmi/cuomo_2020/gene_exp_analysis/low_exp/", col_name, "_low.txt")
  write.table(high, file =  high_path, sep = "\t", col.names = FALSE, row.names = FALSE, quote = FALSE)
  write.table(low, file = low_path, sep = "\t", col.names = FALSE, row.names = FALSE, quote = FALSE) 
}
```
